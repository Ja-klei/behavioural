---
title: "Behavioural Economics Experiment"
author: "Group 9"
date: "`r Sys.Date()`"
output: html_document
---

```{r packages, echo = FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
library(janitor)
library(estimatr)
library(broom)       # for tidy() on models
library(knitr)       # for kable()
library(kableExtra)
library(modelsummary)
library(stringr)
library(fixest)
library(sandwich)
library(lmtest)
```

```{r data, echo = FALSE, message=FALSE, warning=FALSE}
dat <- read_excel("~/Documents/Uni/Behaviroural Economics/Experiment/dat.xlsx", 
    sheet = "total")
```

```{r wrangling, echo = FALSE, message=FALSE, warning=FALSE}
dat <- dat %>%
  mutate(d_m = m_cd - m_ab) %>%
  mutate(choice = paste0(AB,CD))

treat_names <- c( 
  "0" = "Small Treatment",
  "1" = "Large Treatment"# defining facet names
)

dat <- dat %>%
  mutate(
    y_AB = if_else(AB == "a", 1, 0),# 1 is the sure option, 0 is the risky option 
    y_CD = if_else(CD == "c", 1, 0)
  )

sign_dat <- dat %>%
  group_by(treatment) %>%
  mutate(sign = case_when(
    d_m > 0 ~ "CRP",
    d_m < 0 ~ "RCRP",
    TRUE ~ "EU"
  )) %>%
  count(sign) %>%
  mutate(s_prop = n/sum(n))

dat <- dat %>%
  mutate(
    dist_AB = 12 - m_ab,
    dist_CD = 12 - m_cd
  )
dat <- dat %>%
  mutate(
    indic_AB = if_else(dist_AB > 0, 1, 0),
    indic_CD = if_else(dist_CD >0, 1, 0))

dat <- dat %>%
  mutate(
    cre_rcre = case_when(
      choice == "ad" ~ 1,   # CRE pattern
      choice == "bc" ~ -1,  # RCRE pattern
      choice %in% c("ac", "bd") ~ 0  # EU-consistent
    )
  )

dat <- dat %>%
  mutate(
    scaled_value_diff = 0.5 * (1 + 0.2) * d_m
  )

dat <- dat %>%
  mutate(
    m_bar = (m_ab + m_cd) / 2
  )

dat <- dat %>%
  mutate(
    M = 12,  # or whatever your actual M value is
    scaled_dist_indiff = (1 - 0.2) * (M - m_bar)
  )

large_dat <- dat %>%
  filter(treatment == 1)

small_dat <- dat %>%
  filter(treatment == 0)

cre_dat <- dat %>%
  ungroup() %>%
  mutate(
  Effect = case_when(
      choice %in% c("ac", "bd") ~ "EU",
      choice == "ad" ~ "CRE",
      choice == "bc" ~ "RCRE")) %>%
  count(treatment, Effect) %>%
  group_by(treatment) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

x <- dat$d_m[dat$treatment == 0]
y <- dat$d_m[dat$treatment == 1]

crp_dat <- dat %>%
  filter(!is.na(d_m)) %>%  
  mutate(
    Preference = case_when(
      d_m < 0  ~ "RCRP",
      d_m == 0 ~ "EU",
      d_m > 0  ~ "CRP"
    )
  )%>%
  group_by(treatment, Preference) %>%
  summarise(n = n(), .groups = "drop_last") %>%   # count per cell
  group_by(treatment) %>%                         # now normalise within treatment
  mutate(prop = n / sum(n)) %>%
  ungroup()


df_long <- dat %>%
  pivot_longer(
    cols = c(dist_AB, dist_CD, y_AB, y_CD),
    names_to = c(".value", "task"),
    names_pattern = "(.*)_(AB|CD)"
  ) %>%
  mutate(
    abs_delta = abs(dist),
    pred = if_else(dist >= 0, 1L, 0L),
    consistent = as.integer(y == pred),
    task = factor(task, levels = c("AB", "CD"))
  )
df_long <- dat %>%
  select(treatment,
         dist_AB, dist_CD,
         y_AB, y_CD) %>%
  mutate(row = row_number()) %>%       # temp id if needed
  pivot_longer(
    cols = c(dist_AB, dist_CD, y_AB, y_CD),
    names_to = c("variable", "task"),
    names_sep = "_"
  ) %>%
  pivot_wider(
    names_from = variable,
    values_from = value
  ) %>%
  mutate(
    abs_delta = abs(dist),
    pred = if_else(dist >= 0, 1L, 0L),
    consistent = as.integer(y == pred),
    task = factor(task, levels = c("AB", "CD"))
  )

max_delta <- max(df_long$abs_delta, na.rm = TRUE)

df_binned <- df_long %>%
  mutate(abs_delta_round = round(abs_delta)) %>%
  group_by(treatment, task, abs_delta_round) %>%
  summarise(
    consistency = mean(consistent),
    n = n(),
    .groups = "drop"
  )

dat <- dat %>%
  mutate(cons_AB = if_else(
    (dist_AB > 0 & y_AB == 1) | (dist_AB < 0 & y_AB == 0),
    1, 0
  ))

dat <- dat %>%
  mutate(cons_CD = if_else(
    (dist_CD > 0 & y_CD == 1) | (dist_CD < 0 & y_CD == 0),
    1, 0
  ))

dat <- dat %>%
  mutate(
    indic_AB = if_else(dist_AB > 0, 1, 0),
    indic_CD = if_else(dist_CD >0, 1, 0))
    

```

```{r model, message=FALSE, warning=FALSE}
#overall mean test 
mean_test <- t.test(dat$d_m, mu = 0)

tidy(mean_test)

#mean test by treatment 
treat_mean_test <- dat %>%
  group_by(treatment) %>%
  summarise(p_value = t.test(d_m, mu = 0)$p.value)

show(treat_mean_test)

#proportion test for the first round 
prop_test <- prop.test(
  x = c(12, 17),
  n = c(40, 35),
  alternative = "less",
  correct = FALSE
)

show(prop_test)
#treatment effect
model_dm <- lm_robust(d_m ~ treatment, data = dat, se_type = "HC3")
summary(model_dm)

show(model_dm)
#sign data for sign test

sign_dat %>%
  ggplot(aes(x = sign, y = s_prop)) +
  geom_col() +
  facet_wrap(~treatment)

#sign tet
test_dat <- dat %>%
  group_by(treatment) %>%
  mutate(sign = case_when(
    d_m > 0 ~ "CRP",
    d_m < 0 ~ "RCRP",
    TRUE ~ "EU"
  )) %>%
  filter(sign != "EU") %>%
  group_by(treatment) %>%
  summarise(
    n_pos = sum(sign == "CRP"),
    n = n(),
    p_value = binom.test(n_pos, n, p = 0.5, alternative = "two.sided", conf.level = 0.95)$p.value
  )#find results in test dat
show(test_dat)

dat <- dat %>%
  mutate(
    treatment_f = factor(
      treatment,
      levels = c(0, 1),
      labels = c("Small stakes", "Large stakes")
    )
  )

wilcox.test(x, y, paired = FALSE, alternative = "less", conf.int = TRUE)


m_small_AB <- glm(y_AB ~ dist_AB, data = small_dat, family = binomial)
m_small_CD <- glm(y_CD ~ dist_CD, data = small_dat, family = binomial)

m_large_AB <- glm(y_AB ~ dist_AB, data = large_dat, family = binomial)
m_large_CD <- glm(y_CD ~ dist_CD, data = large_dat, family = binomial)

tidy(m_small_AB)
tidy(m_small_CD)
tidy(m_large_AB)
tidy(m_large_CD)


# Small stakes: AB
grid_small_AB <- tibble(
  dist = seq(
    from = min(small_dat$dist_AB, na.rm = TRUE),
    to   = max(small_dat$dist_AB, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_small_AB, newdata = tibble(dist_AB = dist), type = "response"),
    treatment_f  = "Small stakes",
    task_f       = "AB"
  )

# Small stakes: CD
grid_small_CD <- tibble(
  dist = seq(
    from = min(small_dat$dist_CD, na.rm = TRUE),
    to   = max(small_dat$dist_CD, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_small_CD, newdata = tibble(dist_CD = dist), type = "response"),
    treatment_f  = "Small stakes",
    task_f       = "CD"
  )

# Large stakes: AB
grid_large_AB <- tibble(
  dist = seq(
    from = min(large_dat$dist_AB, na.rm = TRUE),
    to   = max(large_dat$dist_AB, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_large_AB, newdata = tibble(dist_AB = dist), type = "response"),
    treatment_f  = "Large stakes",
    task_f       = "AB"
  )

# Large stakes: CD
grid_large_CD <- tibble(
  dist = seq(
    from = min(large_dat$dist_CD, na.rm = TRUE),
    to   = max(large_dat$dist_CD, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_large_CD, newdata = tibble(dist_CD = dist), type = "response"),
    treatment_f  = "Large stakes",
    task_f       = "CD"
  )

# Combine all predictions
pred_all <- bind_rows(
  grid_small_AB, grid_small_CD,
  grid_large_AB, grid_large_CD
) %>%
  mutate(
    treatment_f = factor(
      treatment_f,
      levels = c("Small stakes", "Large stakes")   # left → right
    )
  )

logit_model <- ggplot(pred_all, aes(x = dist, y = p, colour = task_f)) +
  geom_line(size = 1) +
  facet_wrap(~ treatment_f, nrow = 1) +
  theme_classic() +
  labs(
    x      = expression(Delta == M - m),
    y      = "Pr(choose safe option)",
    colour = "Task"
  )

show(logit_model)

logit_model <- logit_model +
  theme(
    axis.text  = element_text(size = 18),
    axis.title = element_text(size = 20),
    plot.title = element_text(size = 22, face = "bold")
  )

ggsave(
  "logit_model.png",
  plot = logit_model,
  units = "in",
  width  = 13.33,
  height = 7.5,
  dpi = 300
)

ggplot(df_binned,
       aes(x = abs_delta_round, y = consistency, colour = task)) +
  geom_point(size = 2) +
  geom_line() +
  facet_wrap(~ treatment) +
  theme_minimal(base_size = 14) +
  labs(
    x = "|Δ| (distance from indifference)",
    y = "Consistency with valuation",
    colour = "Task"
  )


cons_AB_mod <- glm(cons_AB ~ treatment, family = "binomial" (link = "probit"), data = dat)

summary(cons_AB_mod)

cons_CD_mod <- glm(cons_CD ~ treatment, family = "binomial" (link = "probit"), data = dat)

summary(cons_AB_mod)

model_full <- feols(
  cre_rcre ~ scaled_value_diff + scaled_dist_indiff | treatment,
  data = dat,
  vcov = "hetero"
)

show(model_full)

ggplot(dat, aes(x = scaled_value_diff, y = cre_rcre)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  labs(title = "CRE-RCRE by Value Difference") +
  theme_minimal()

ggplot(dat, aes(x = scaled_dist_indiff, y = cre_rcre)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  labs(title = "CRE-RCRE by Distance to Indifference")+
  theme("minimal")

modelss <- lm(cre_rcre ~ scaled_value_diff + scaled_dist_indiff + factor(treatment),
            data = dat)
summary(modelss)

model_interact1 <- lm(
  cre_rcre ~ scaled_value_diff * factor(treatment) + scaled_dist_indiff,
  data = dat
)
summary(model_interact1)

t.test(cre_rcre ~ treatment, data = dat)

ggplot(dat, aes(x = factor(treatment), y = cre_rcre, fill = factor(treatment))) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.3) +
  labs(
    title = "CRE-RCRE by Stake Size",
    x = "Treatment (0 = Low Stakes, 1 = High Stakes)",
    y = "CRE-RCRE"
  ) +
  theme_minimal()

model_AB <- glm(y_AB ~ dist_AB * factor(treatment), 
                data = dat, 
                family = binomial(link = "logit"))
summary(model_AB)

# For CD choices  
model_CD <- glm(y_CD ~ dist_CD * factor(treatment),
                data = dat,
                family = binomial(link = "logit"))
summary(model_CD)
```

```{r summary stats, echo = FALSE, message=FALSE, warning=FALSE}
med_d_m <- dat %>%
  group_by(treatment) %>%
  summarise(med = median(d_m, na.rm = TRUE), .groups = "drop")

dat %>% #relative frequencies of first round choices and treatment
  group_by(treatment, choice) %>%
  summarise(n = n()) %>%
  mutate(freq = n/sum(n)) %>%
  ungroup()

dat %>%
  group_by(treatment) %>%
  summarise(med = median(d_m, na.rm = TRUE))

```

```{r plots, echo = FALSE, message=FALSE, warning=FALSE}


plot_dat <- dat %>% #plot data for round 1 can be found in plot_dat
  group_by(treatment, choice) %>% #group by treatment and choice
  summarise(n = n(), .groups = "drop") %>% #count all the occurrences of every choice in every treatment
  group_by(treatment) %>% #group by treatment again 
  mutate(prop = n/sum(n)) %>% #compute proportional levels of n for each treatment and choice setting 
  ungroup() %>% #ungroup for cleanliness 
  mutate(choice = factor(choice, levels = c("ac","ad","bc","bd"))) #factor so the ranking on the graph is correct 

treat_names <- c( 
  "0" = "Small Stakes",
  "1" = "Large Stakes"# defining facet names
)

abcd_plot <- ggplot(plot_dat, aes(x = choice, y = prop, fill = choice)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~ treatment, nrow = 1, labeller = labeller(treatment = treat_names)) +
  labs(
    x = "Choice (AC, AD, BC, BD)",
    y = "Proportion within treatment",
    title = "Choice distribution by treatment"
  ) +
  theme_classic() +
  scale_fill_brewer(palette = "Blues")
show(abcd_plot)


cre_plot <- cre_dat %>%
  ggplot(aes(x = Effect, y = prop, fill = Effect)) +
  geom_col()+
  facet_wrap(~treatment,labeller = labeller(treatment = treat_names)) +
  scale_fill_brewer(palette = "Blues") +
  theme_classic() +
  labs(
    x = "CRE, RCRE, or Expected Utility",
    y = "proprtion",
    title = "Occurences of Common Ratio Preference choices"
  )

show(cre_plot)

cre_plot <- cre_plot +
  theme(
    axis.text  = element_text(size = 18),
    axis.title = element_text(size = 20),
    plot.title = element_text(size = 22, face = "bold")
  )

ggsave(
  "cre_plot.png",
  plot = cre_plot,
  units = "in",
  width  = 13.33,
  height = 7.5,
  dpi = 300
)

d_m_plot <- dat %>%
  ggplot(aes(x = d_m))+
  geom_bar(fill = "steelblue") +
  facet_wrap(~treatment, nrow = 1, labeller = labeller(treatment = treat_names)) +
  geom_vline(xintercept = 0, color = "black") +
  geom_vline(
    data = med_d_m,
    aes(xintercept = med),
    linewidth = 0.8,
    color = "red") +
   geom_text(
    data = med_d_m,
    aes(x = med, y = 0, label = "median"),
    vjust = -50,
    hjust = -0.5,
    colour = "red",
    angle = 0) +
  theme_classic() +
  labs(
    x = "∆m for treatment 1 and 2",
    y = "count",
    title = "Delta m of treatment one and two with median."
  )

show(d_m_plot)
d_m_plot<-d_m_plot +
  theme(
    axis.text  = element_text(size = 18),
    axis.title = element_text(size = 20),
    plot.title = element_text(size = 22, face = "bold")
  )

ggsave(
  "d_m_plot.png",
  plot = d_m_plot,
  units = "in",
  width  = 13.33,
  height = 7.5,
  dpi = 300
)

dat %>%
ggplot(aes(x = d_m)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "grey50") +
  geom_density() +
  facet_wrap(~treatment)


crp_plot <- crp_dat %>%
  ggplot(aes(x = Preference, y = prop, fill = Preference)) +
  geom_col()+
  facet_wrap(~treatment,labeller = labeller(treatment = treat_names)) +
  scale_fill_brewer(palette = "Blues") +
  theme_classic() +
  labs(
    x = "CRP, RCRP, or Expected Utility",
    y = "proprtion",
    title = "Occurences of Common Ratio Preference choices"
  )

show(crp_plot)

ggsave(
  "crp_plot.png",
  plot = crp_plot,
  units = "in",
  width  = 13.33,
  height = 7.5,
  dpi = 300
)


```

```

