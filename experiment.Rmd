---
title: "Behavioural Economics Experiment"
author: "Group 9"
date: "`r Sys.Date()`"
output: html_document
---

```{r packages, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
library(janitor)
library(estimatr)
library(broom)       # for tidy() on models
library(knitr)       # for kable()
library(kableExtra)  # for nicer tables
```

```{r data, echo = FALSE}
dat <- read_excel("~/Documents/Uni/Behaviroural Economics/Experiment/dat.xlsx", 
    sheet = "total")
```

```{r wrangling, echo = FALSE}
dat <- dat %>%
  mutate(d_m = m_cd - m_ab) %>%
  mutate(choice = paste0(AB,CD))

dat <- dat %>%
  mutate(
    y_AB = if_else(AB == "a", 1, 0),# 1 is the sure option, 0 is the risky option 
    y_CD = if_else(CD == "c", 1, 0)
  )

sign_dat <- dat %>%
  group_by(treatment) %>%
  mutate(sign = case_when(
    d_m > 0 ~ "CRP",
    d_m < 0 ~ "RCRP",
    TRUE ~ "EU"
  )) %>%
  count(sign) %>%
  mutate(s_prop = n/sum(n))

dat <- dat %>%
  mutate(
    dist_AB = 12 - m_ab,
    dist_CD = 12 - m_cd
  )

large_dat <- dat %>%
  filter(treatment == 1)

small_dat <- dat %>%
  filter(treatment == 0)


```

```{r model}
#overall mean test 
mean_test <- t.test(dat$d_m, mu = 0)

tidy(mean_test)

#mean test by treatment 
treat_mean_test <- dat %>%
  group_by(treatment) %>%
  summarise(p_value = t.test(d_m, mu = 0)$p.value)

tidy(treat_mean_test)

#treatment effect
model_dm <- lm_robust(d_m ~ treatment, data = dat, se_type = "HC3")
summary(model_dm)

tidy(model_dm)

#sign data for sign test

sign_dat %>%
  ggplot(aes(x = sign, y = s_prop)) +
  geom_col() +
  facet_wrap(~treatment)

#sign tet
test_dat <- dat %>%
  group_by(treatment) %>%
  mutate(sign = case_when(
    d_m > 0 ~ "CRP",
    d_m < 0 ~ "RCRP",
    TRUE ~ "EU"
  )) %>%
  filter(sign != "EU") %>%
  group_by(treatment) %>%
  summarise(
    n_pos = sum(sign == "CRP"),
    n = n(),
    p_value = binom.test(n_pos, n, p = 0.5, alternative = "two.sided", conf.level = 0.95)$p.value
  )#find results in test dat
show(test_dat)

dat <- dat %>%
  mutate(
    treatment_f = factor(
      treatment,
      levels = c(0, 1),
      labels = c("Small stakes", "Large stakes")
    )
  )

m_small_AB <- glm(y_AB ~ dist_AB, data = small_dat, family = binomial)
m_small_CD <- glm(y_CD ~ dist_CD, data = small_dat, family = binomial)

m_large_AB <- glm(y_AB ~ dist_AB, data = large_dat, family = binomial)
m_large_CD <- glm(y_CD ~ dist_CD, data = large_dat, family = binomial)

tidy(m_small_AB)
tidy(m_small_CD)
tidy(m_large_AB)
tidy(m_large_CD)


# Small stakes: AB
grid_small_AB <- tibble(
  dist = seq(
    from = min(small_dat$dist_AB, na.rm = TRUE),
    to   = max(small_dat$dist_AB, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_small_AB, newdata = tibble(dist_AB = dist), type = "response"),
    treatment_f  = "Small stakes",
    task_f       = "AB"
  )

# Small stakes: CD
grid_small_CD <- tibble(
  dist = seq(
    from = min(small_dat$dist_CD, na.rm = TRUE),
    to   = max(small_dat$dist_CD, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_small_CD, newdata = tibble(dist_CD = dist), type = "response"),
    treatment_f  = "Small stakes",
    task_f       = "CD"
  )

# Large stakes: AB
grid_large_AB <- tibble(
  dist = seq(
    from = min(large_dat$dist_AB, na.rm = TRUE),
    to   = max(large_dat$dist_AB, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_large_AB, newdata = tibble(dist_AB = dist), type = "response"),
    treatment_f  = "Large stakes",
    task_f       = "AB"
  )

# Large stakes: CD
grid_large_CD <- tibble(
  dist = seq(
    from = min(large_dat$dist_CD, na.rm = TRUE),
    to   = max(large_dat$dist_CD, na.rm = TRUE),
    length.out = 300
  )
) %>%
  mutate(
    p            = predict(m_large_CD, newdata = tibble(dist_CD = dist), type = "response"),
    treatment_f  = "Large stakes",
    task_f       = "CD"
  )

# Combine all predictions
pred_all <- bind_rows(
  grid_small_AB, grid_small_CD,
  grid_large_AB, grid_large_CD
) %>%
  mutate(
    treatment_f = factor(
      treatment_f,
      levels = c("Small stakes", "Large stakes")   # left → right
    )
  )

ggplot(pred_all, aes(x = dist, y = p, colour = task_f)) +
  geom_line(size = 1) +
  facet_wrap(~ treatment_f, nrow = 1) +
  theme_classic() +
  labs(
    x      = expression(Delta == M - m),
    y      = "Pr(choose safe option)",
    colour = "Task"
  )



```

```{r summary stats, echo = FALSE}
med_d_m = dat %>%
  group_by(treatment) %>%
  summarise(med = median(d_m, na.rm = TRUE), .groups = "drop")

dat %>% #relative frequencies of first round choices and treatment
  group_by(treatment, choice) %>%
  summarise(n = n()) %>%
  mutate(freq = n/sum(n)) %>%
  ungroup()

```

```{r plots, echo = FALSE}
plot_dat <- dat %>% #plot data for round 1 can be found in plot_dat
  group_by(treatment, choice) %>% #group by treatment and choice
  summarise(n = n(), .groups = "drop") %>% #count all the occurrences of every choice in every treatment
  group_by(treatment) %>% #group by treatment again 
  mutate(prop = n/sum(n)) %>% #compute proportional levels of n for each treatment and choice setting 
  ungroup() %>% #ungroup for cleanliness 
  mutate(choice = factor(choice, levels = c("ac","ad","bc","bd"))) #factor so the ranking on the graph is correct 

treat_names <- c( 
  "0" = "Small Treatment",
  "1" = "Large Treatment"# defining facet names
)

abcd_plot <- ggplot(plot_dat, aes(x = choice, y = prop, fill = choice)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~ treatment, nrow = 1, labeller = labeller(treatment = treat_names)) +
  labs(
    x = "Choice (AC, AD, BC, BD)",
    y = "Proportion within treatment",
    title = "Choice distribution by treatment"
  ) +
  theme_classic() +
  scale_fill_brewer(palette = "Greens")
show(abcd_plot)


cre_dat <- dat %>%
  ungroup() %>%
  mutate(
  choice3 = case_when(
      choice %in% c("ac", "bd") ~ "EU",
      choice == "ad" ~ "CRP",
      choice == "bc" ~ "RCRP")) %>%
  count(treatment, choice3) %>%
  group_by(treatment) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

cre_plot <- cre_dat %>%
  ggplot(aes(x = choice3, y = prop, fill = choice3)) +
  geom_col()+
  facet_wrap(~treatment,labeller = labeller(treatment = treat_names)) +
  scale_fill_brewer(palette = "Greens") +
  theme_classic() +
  labs(
    x = "CRP, RCRP, or Expected Utility",
    y = "proprtion",
    title = "Occurences of Common Ratio Preference choices"
  )


show(cre_plot)

d_m_plot <- dat %>%
  ggplot(aes(x = d_m))+
  geom_bar()+
  facet_wrap(~treatment, nrow = 1) +
  geom_vline(xintercept = 0, color = "black") +
  geom_vline(
    data = med_d_m,
    aes(xintercept = med),
    linewidth = 0.8,
    color = "red") +
   geom_text(
    data = med_d_m,
    aes(x = med, y = 0, label = "median"),
    vjust = -30,
    hjust = -0.2,
    colour = "red",
    angle = 0) +
  theme_classic() +
  labs(
    x = "∆m for treatment 1 and 2",
    y = "count",
    title = "Delta m of treatment one and two with median."
  )

show(d_m_plot)



dat %>%
ggplot(aes(x = d_m)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "grey50") +
  geom_density() +
  facet_wrap(~treatment)



```

```

